{% extends 'base.html' %}
{% load static %}

{% block title %}Login{% endblock %}

{% block body-class %}hold-transition login-page{% endblock %}

{% block body %}

    <div class="login-box small">
        <div class="login-logo">
            <a href="/"><b>Tax</b>SYS</a>
            <h1>{{ tenant.name }}</h1>
        </div>

        <div class="card">
            <div class="card-body login-card-body">
                <p class="text-center">You have successfully logged in as a CEO and given permissions to TaxSYS. Please
                    wait
                    while TaxSYS gathers information on you and your available corporations.</p>

                <div class="text-center" style="margin-bottom:15px;">

                </div>

                <div class="progress mb-3" style="margin-bottom:0px !important;">
                    <div class="progress-bar bg-info" id="director-progress" role="progressbar" aria-valuenow="0"
                         aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                        <span class="sr-only">0% Complete</span>
                    </div>
                </div>
                <small><p id="status-text">Getting Characters...</p></small>

                <a href="{% url 'logout' %}" class="btn btn-success btn-block disabled" id="continue-button"><i
                        class="fas fa-sync-alt fa-spin"></i></a>
            </div>
        </div>

        <div class="alert alert-info">
            <h5><i class="icon fas fa-info"></i> Info</h5>
            Do not close this window until complete
        </div>
    </div>

{% endblock %}

{% block javascripts %}

    <script type="text/javascript">

        $(document).ready(() => {

            $.get('{% url 'ajax_director_get_characters' %}', (r) => {

                let total_chars = r.characters.length;

                $('#status-text').html('Found ' + total_chars + ' Characters...');

                process_characters(r.characters);

            }, 'json');

            async function process_characters(characters) {

                let total_chars = characters.length;
                let progress_unit = 100 / total_chars;

                for (i = 0; i < total_chars; i++) {


                    $('#status-text').html('Processing ' + characters[i] + '...');
                    const result = await $.get('{% url 'ajax_director_get_character' %}' + characters[i], (r) => {
                        console.log(r);
                        // Update Progress
                        $('#director-progress').attr('style', 'width:' + ((i + 1) * progress_unit) + '%');
                    }, 'json');
                }

                $('#continue-button').removeClass('disabled');
                $('#continue-button').html('Finish and Logout');
            }

        });

    </script>

{% endblock %}